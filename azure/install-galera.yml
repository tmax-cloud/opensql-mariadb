steps:

  - bash: |
      set -x

      if [[ -e /usr/bin/apt-get ]]; then
        sudo apt update
        sudo apt install -y dirmngr lsb-release
        DEBIAN_VERSION=$(lsb_release -sc)
        sudo bash -c "echo deb http://downloads.mariadb.com/galera-test/repo4/deb ${DEBIAN_VERSION} main > /etc/apt/sources.list.d/galera.list"
        sudo apt-key adv --recv-keys --keyserver hkp://keyserver.ubuntu.com:80 0xCE1A3DD5E3C94F49
        sudo apt update
        DEBIAN_FRONTEND=noninteractive sudo apt install -y galera-enterprise-4 galera-arbitrator-4 rsync netcat socat
      fi

      if [[ -e /usr/bin/yum ]]; then
        RELEASE=$(lsb_release -r | awk '{print substr($NF,1,1)}')
        sudo sh -c "echo '[galera]' > /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'name=galera' >> /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'baseurl=http://downloads.mariadb.com/galera-test/repo4/rpm/rhel/'${RELEASE}'/\$basearch/' >> /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'gpgkey=https://downloads.mariadb.com/MariaDB/RPM-GPG-KEY-MariaDB-Ent' >> /etc/yum.repos.d/galera.repo"
        sudo sh -c "echo 'gpgcheck=1' >> /etc/yum.repos.d/galera.repo"
        sudo cat /etc/yum.repos.d/galera.repo
        sudo yum -y clean all
        sudo yum install -y galera-enterprise-4 rsync socat lsof
      fi

      if [[ -e /usr/bin/zypper ]]; then
        sudo zypper -n in wget || true
        source /etc/os-release
        RELEASE=${VERSION_ID%.*}
        wget https://downloads.mariadb.com/MariaDB/RPM-GPG-KEY-MariaDB-Ent -O /tmp/rpm.key
        sudo rpm --import /tmp/rpm.key && rm -f /tmp/rpm.key
        sudo zypper rr Galera-Enterprise || true
        sudo zypper ar -f -g http://downloads.mariadb.com/galera-test/repo4/rpm/sles/${RELEASE}/x86_64/ Galera-Enterprise
        sudo zypper refresh -sf
        sudo zypper -n in galera-enterprise-4 rsync socat lsof
      fi
    displayName: "Install Galera-Enterprise-4"
    condition: succeededOrFailed()
